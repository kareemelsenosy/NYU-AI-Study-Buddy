name: Verify Commits

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint
      
    - name: Type check
      run: npx tsc --noEmit
      
    - name: Build project
      run: npm run build
      env:
        PORTKEY_API_KEY: ${{ secrets.PORTKEY_API_KEY || 'test-key' }}
        PORTKEY_BASE_URL: ${{ secrets.PORTKEY_BASE_URL || 'https://ai-gateway.apps.cloud.rt.nyu.edu/v1' }}
        AI_MODEL: ${{ secrets.AI_MODEL || '@vertexai/gemini-2.5-pro' }}
        Files_READ_WRITE_TOKEN: ${{ secrets.Files_READ_WRITE_TOKEN || 'test-token' }}
        NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}
        
    - name: Verify commit message format
      run: |
        COMMIT_MSG=$(git log -1 --pretty=%B)
        if [[ ! "$COMMIT_MSG" =~ ^[A-Z] ]]; then
          echo "⚠️  Warning: Commit message should start with capital letter"
        fi
        echo "✅ Commit message verified: $COMMIT_MSG"
        
    - name: Check for large files
      run: |
        LARGE_FILES=$(find . -type f -size +5M ! -path './node_modules/*' ! -path './.next/*' ! -path './.git/*')
        if [ -n "$LARGE_FILES" ]; then
          echo "⚠️  Warning: Large files detected:"
          echo "$LARGE_FILES"
        else
          echo "✅ No large files detected"
        fi

